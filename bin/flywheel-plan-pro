#!/usr/bin/env bash
# flywheel-plan-pro: Guided planning with GPT Pro web integration
set -euo pipefail

PROJECT_DIR="$(pwd)"
PROJECT_NAME="$(basename "$PROJECT_DIR")"
PLANNING_DIR="$PROJECT_DIR/planning"
ROUNDS=${1:-3}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Create planning directory
mkdir -p "$PLANNING_DIR"

clear 2>/dev/null || true
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  ${BOLD}FLYWHEEL PLAN-PRO${NC}${BLUE} - Guided Planning with GPT Pro Integration   â•‘${NC}"
echo -e "${BLUE}â•‘  Project: $PROJECT_NAME${NC}"
echo -e "${BLUE}â•‘  Rounds: $ROUNDS (GPT Pro â†’ Claude Code iterations)${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# ============================================================================
# STEP 1: Initial Plan
# ============================================================================
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  STEP 1: Initial Plan Creation${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo

if [[ -f "$PLANNING_DIR/PLAN_v0.md" ]]; then
    echo -e "${GREEN}âœ“ Found existing plan: $PLANNING_DIR/PLAN_v0.md${NC}"
    echo -e "  Lines: $(wc -l < "$PLANNING_DIR/PLAN_v0.md")"
else
    echo -e "${YELLOW}No initial plan found.${NC}"
    echo
    echo "Options:"
    echo "  1) Run 'flywheel plan' first for interactive interview"
    echo "  2) Run 'flywheel compete' for multi-model plan generation"
    echo "  3) Create $PLANNING_DIR/PLAN_v0.md manually"
    echo
    read -p "Press Enter after creating initial plan, or Ctrl+C to exit..."
    
    if [[ ! -f "$PLANNING_DIR/PLAN_v0.md" ]]; then
        echo -e "${RED}Error: Still no plan found. Exiting.${NC}"
        exit 1
    fi
fi

CURRENT_PLAN="$PLANNING_DIR/PLAN_v0.md"
echo

# ============================================================================
# STEP 2-N: GPT Pro Refinement Rounds
# ============================================================================
for round in $(seq 1 $ROUNDS); do
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}  ROUND $round/$ROUNDS: GPT Pro Review${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo
    
    # Show plan location
    echo -e "${BOLD}ğŸ“„ Current Plan:${NC} $CURRENT_PLAN"
    echo -e "   Lines: $(wc -l < "$CURRENT_PLAN") | Size: $(du -h "$CURRENT_PLAN" | cut -f1)"
    echo
    
    # Try to copy plan to clipboard (graceful failure)
    if command -v pbcopy &> /dev/null; then
        cat "$CURRENT_PLAN" | pbcopy 2>/dev/null && echo -e "${GREEN}âœ“ Plan copied to clipboard!${NC}" || true
    elif command -v xclip &> /dev/null && [[ -n "${DISPLAY:-}" ]]; then
        cat "$CURRENT_PLAN" | xclip -selection clipboard 2>/dev/null && echo -e "${GREEN}âœ“ Plan copied to clipboard!${NC}" || true
    else
        echo -e "${YELLOW}ğŸ“‹ Copy the plan manually:${NC}"
        echo -e "   cat $CURRENT_PLAN"
        echo
    fi
    echo
    
    # Show the prompt to use
    echo -e "${BOLD}ğŸ“‹ COPY THIS PROMPT TO GPT 5.2 PRO (Extended Reasoning):${NC}"
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    cat << 'PROMPT'
Carefully review this entire plan for me and come up with your best revisions 
in terms of better architecture, new features, changed features, etc. to make 
it better, more robust/reliable, more performant, more compelling/useful, etc. 
For each proposed change, give me your detailed analysis and rationale/justification 
for why it would make the project better along with the git-diff style change 
versus the original plan shown below:
PROMPT
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo
    echo -e "${BOLD}Then paste your plan content after the prompt.${NC}"
    echo
    
    # Wait for user to complete GPT Pro review
    echo -e "${CYAN}ğŸŒ Open: https://chat.openai.com (GPT Pro with Extended Reasoning)${NC}"
    echo
    read -p "Press Enter when GPT Pro has finished reviewing..."
    echo
    
    # Get GPT output
    echo -e "${BOLD}ğŸ“¥ Paste GPT Pro's response below (end with Ctrl+D on empty line):${NC}"
    GPT_OUTPUT_FILE="$PLANNING_DIR/gpt_round${round}.md"
    cat > "$GPT_OUTPUT_FILE"
    echo
    echo -e "${GREEN}âœ“ Saved GPT output to: $GPT_OUTPUT_FILE${NC}"
    echo -e "   Lines: $(wc -l < "$GPT_OUTPUT_FILE")"
    echo
    
    # Now integrate with Claude Code
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}  ROUND $round/$ROUNDS: Claude Code Integration${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo
    
    NEW_PLAN="$PLANNING_DIR/PLAN_v$round.md"
    
    # Show integration prompt
    echo -e "${BOLD}Running Claude Code to integrate revisions...${NC}"
    echo -e "Creating: $NEW_PLAN"
    echo
    
    # Create the integration prompt file
    INTEGRATE_PROMPT_FILE="$PLANNING_DIR/.integrate_prompt_$round.txt"
    cat > "$INTEGRATE_PROMPT_FILE" << INTEGRATEPROMPT
Read the current plan at $CURRENT_PLAN and integrate the following GPT Pro revisions.
Save the integrated plan as $NEW_PLAN.

Be meticulous. At the end, tell me which changes you wholeheartedly agree with, 
which you somewhat agree with, and which you disagree with.

GPT Pro's revisions:

$(cat "$GPT_OUTPUT_FILE")
INTEGRATEPROMPT

    # Run Claude Code
    if command -v claude &> /dev/null; then
        claude --dangerously-skip-permissions -p "$(cat "$INTEGRATE_PROMPT_FILE")" 2>&1 | tee "$PLANNING_DIR/integration_round${round}.log"
    else
        echo -e "${RED}Error: claude command not found${NC}"
        echo -e "Please run this manually:"
        echo -e "  claude -p '$(head -5 "$INTEGRATE_PROMPT_FILE")...'"
    fi
    
    # Check if new plan was created
    if [[ -f "$NEW_PLAN" ]]; then
        echo
        echo -e "${GREEN}âœ“ Created: $NEW_PLAN${NC}"
        echo -e "   Lines: $(wc -l < "$NEW_PLAN")"
        CURRENT_PLAN="$NEW_PLAN"
    else
        echo -e "${YELLOW}âš  New plan not auto-created. Claude may have written to a different path.${NC}"
        echo -e "Check the output above and manually copy if needed."
        read -p "Press Enter to continue..."
        
        # Check again after user interaction
        if [[ -f "$NEW_PLAN" ]]; then
            CURRENT_PLAN="$NEW_PLAN"
        fi
    fi
    echo
    
    # Show diff if possible
    if [[ $round -gt 1 ]]; then
        PREV_PLAN="$PLANNING_DIR/PLAN_v$((round-1)).md"
        if [[ -f "$PREV_PLAN" ]] && [[ -f "$NEW_PLAN" ]]; then
            echo -e "${BOLD}Changes from v$((round-1)) to v$round:${NC}"
            diff --stat "$PREV_PLAN" "$NEW_PLAN" 2>/dev/null || true
        fi
    fi
    echo
done

# ============================================================================
# FINAL: Summary and Next Steps
# ============================================================================
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘  ${BOLD}PLAN REFINEMENT COMPLETE${NC}${GREEN}                                        â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo
echo -e "${BOLD}ğŸ“„ Plan Versions:${NC}"
ls -la "$PLANNING_DIR"/PLAN_v*.md 2>/dev/null | while read line; do
    echo "   $line"
done
echo
echo -e "${BOLD}ğŸ“„ Final Plan:${NC} $CURRENT_PLAN"
echo -e "   Lines: $(wc -l < "$CURRENT_PLAN")"
echo

# Copy final plan to PLAN.md
cp "$CURRENT_PLAN" "$PLANNING_DIR/PLAN.md"
echo -e "${GREEN}âœ“ Copied to: $PLANNING_DIR/PLAN.md${NC}"
echo

echo -e "${BOLD}Next Steps:${NC}"
echo "  1. flywheel beads --min-beads 50    # Convert plan to beads"
echo "  2. flywheel polish --max 9          # Polish beads (6-9 iterations)"
echo "  3. flywheel startwork --cc 2        # Start agent swarm"
echo
