#!/usr/bin/env bash
# Flywheel Watchdog - nudges IDLE agents every N seconds
# Default completion: actionable_count == 0 AND triage in_progress == 0
# Strict completion (FW_COMPLETE_ALL_STATUSES=1): all non-closed statuses are zero
#   (open + in_progress + blocked + deferred == 0)
# Triage dispatch: caches bv --robot-triage and passes to nudge for
# dependency-aware task assignment to idle agents.

set -euo pipefail

SESSION="${1:-}"
INTERVAL="${2:-60}"
MAX_ZERO_CHECKS="${3:-3}"  # Exit after N consecutive done checks

[[ -n "$SESSION" ]] || { echo "Usage: flywheel-watchdog <session> [interval] [max_zero_checks]"; exit 1; }

STRICT_ALL="${FW_COMPLETE_ALL_STATUSES:-0}"
TRIAGE_FILE="/tmp/flywheel-triage-${SESSION}.json"

count_status() {
  local status="$1"
  bd count --status "$status" 2>/dev/null || echo 0
}

echo "Watchdog started: session=$SESSION interval=${INTERVAL}s"
echo "Only nudges idle agents (skips working ones)"
echo "Triage dispatch: ON (assigns scored tasks to idle agents)"
if [[ "$STRICT_ALL" == "1" ]]; then
  echo "Mode: STRICT_ALL_STATUSES (open+in_progress+blocked+deferred must be 0)"
else
  echo "Mode: ACTIONABLE_ONLY (actionable=0 and triage in_progress=0)"
fi
echo "Will exit after $MAX_ZERO_CHECKS consecutive done checks"
echo "Press Ctrl+C to stop"

# Find the repo root from session name
REPO_ROOT="/data/projects/$SESSION"
[[ -d "$REPO_ROOT" ]] || REPO_ROOT="."

ZERO_COUNT=0

while true; do
  sleep "$INTERVAL"

  if ! tmux has-session -t "$SESSION" 2>/dev/null; then
    echo "Session $SESSION gone. Exiting."
    exit 0
  fi

  cd "$REPO_ROOT" 2>/dev/null || true

  # Cache triage once per cycle (was called twice before)
  bv --robot-triage 2>/dev/null > "$TRIAGE_FILE" || echo '{}' > "$TRIAGE_FILE"

  ACTIONABLE=$(jq -r ".triage.quick_ref.actionable_count // 0" "$TRIAGE_FILE" 2>/dev/null || echo "0")
  TRIAGE_IN_PROGRESS=$(jq -r ".triage.quick_ref.in_progress_count // 0" "$TRIAGE_FILE" 2>/dev/null || echo "0")

  OPEN_COUNT=$(count_status open)
  INPROG_COUNT=$(count_status in_progress)
  BLOCKED_COUNT=$(count_status blocked)
  DEFERRED_COUNT=$(count_status deferred)

  NON_CLOSED=$((OPEN_COUNT + INPROG_COUNT + BLOCKED_COUNT + DEFERRED_COUNT))

  echo "$(date +%H:%M:%S) Actionable:$ACTIONABLE | TriageInProg:$TRIAGE_IN_PROGRESS | Open:$OPEN_COUNT InProg:$INPROG_COUNT Blocked:$BLOCKED_COUNT Deferred:$DEFERRED_COUNT"

  done_now=0
  if [[ "$STRICT_ALL" == "1" ]]; then
    [[ "$NON_CLOSED" -eq 0 ]] && done_now=1
  else
    [[ "$ACTIONABLE" -eq 0 && "$TRIAGE_IN_PROGRESS" -eq 0 ]] && done_now=1
  fi

  if [[ "$done_now" -eq 1 ]]; then
    ZERO_COUNT=$((ZERO_COUNT + 1))
    echo "  → Done condition met (check $ZERO_COUNT/$MAX_ZERO_CHECKS)"

    if [[ "$ZERO_COUNT" -ge "$MAX_ZERO_CHECKS" ]]; then
      echo ""
      echo "════════════════════════════════════════════════════════════"
      echo "  ✅ WATCHDOG COMPLETE"
      if [[ "$STRICT_ALL" == "1" ]]; then
        echo "  Non-closed statuses: 0"
      else
        echo "  Actionable beads: 0 | Triage in-progress: 0"
      fi
      echo "  Consecutive done checks: $ZERO_COUNT"
      echo "════════════════════════════════════════════════════════════"
      echo ""
      echo "Running finalize..."
      flywheel finalize 2>&1 || true
      echo ""
      echo "Watchdog exiting. Session still running for review."
      rm -f "$TRIAGE_FILE"
      exit 0
    fi
  else
    ZERO_COUNT=0
    echo "$(date +%H:%M:%S) Checking for idle agents..."
    if [[ "$STRICT_ALL" == "1" && "$NON_CLOSED" -gt 0 && "$ACTIONABLE" -eq 0 ]]; then
      echo "$(date +%H:%M:%S) No actionable beads but non-closed remain; forcing nudge for unblock/closure work."
      flywheel nudge --force --triage-file "$TRIAGE_FILE" 2>&1 | grep -E "(Nudging|Skipping|Nudged|Dispatch)" || true
    else
      flywheel nudge --triage-file "$TRIAGE_FILE" 2>&1 | grep -E "(Nudging|Skipping|Nudged|Dispatch)" || true
    fi
  fi
done
