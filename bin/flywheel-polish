#!/usr/bin/env bash
# flywheel-polish: Iterative bead refinement ("Measure N Times")
set -euo pipefail

MAX_ITERS=${1:-9}
PLAN_FILE="${2:-planning/PLAN.md}"
PROJECT_DIR="$(pwd)"
PROJECT_NAME="$(basename "$PROJECT_DIR")"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  FLYWHEEL POLISH - Iterative Bead Refinement${NC}"
echo -e "${BLUE}  Max iterations: $MAX_ITERS | Plan: $PLAN_FILE${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

# Check prerequisites
if [[ ! -f "$PLAN_FILE" ]]; then
    echo -e "${RED}Error: Plan file not found: $PLAN_FILE${NC}"
    exit 1
fi

if ! command -v br &> /dev/null; then
    echo -e "${RED}Error: br (beads_rust) not found${NC}"
    exit 1
fi

# Count initial beads
INITIAL_COUNT=$(br list 2>/dev/null | wc -l || echo "0")
echo -e "${YELLOW}Initial bead count: $INITIAL_COUNT${NC}"

# The polish prompt
POLISH_PROMPT="Reread AGENTS dot md so it's still fresh in your mind. Then read ALL of $PLAN_FILE. Use ultrathink. Check over each bead super carefully-- are you sure it makes sense? Is it optimal? Could we change anything to make the system work better for users? If so, revise the beads. It's a lot easier and faster to operate in \"plan space\" before we start implementing these things!

DO NOT OVERSIMPLIFY THINGS! DO NOT LOSE ANY FEATURES OR FUNCTIONALITY!

Also make sure that as part of the beads we include comprehensive unit tests and e2e test scripts with great, detailed logging so we can be sure that everything is working perfectly after implementation. It's critical that EVERYTHING from the markdown plan be embedded into the beads so that we never need to refer back to the markdown plan and we don't lose any important context or ideas or insights into the new features planned and why we are making them.

Remember to ONLY use the bd/br tool to create and modify the beads and add the dependencies."

# Create tmux session for polish
SESSION="polish-$PROJECT_NAME"

if tmux has-session -t "$SESSION" 2>/dev/null; then
    echo -e "${YELLOW}Existing polish session found. Attaching...${NC}"
    tmux attach -t "$SESSION"
    exit 0
fi

# Create session
tmux new-session -d -s "$SESSION" -c "$PROJECT_DIR"

# Run polish iterations
for i in $(seq 1 $MAX_ITERS); do
    echo -e "${GREEN}Starting iteration $i of $MAX_ITERS...${NC}"
    
    # Send prompt to claude
    tmux send-keys -t "$SESSION" "echo '=== POLISH ITERATION $i/$MAX_ITERS ===' && claude --dangerously-skip-permissions -p \"$POLISH_PROMPT\"" Enter
    
    # Wait for completion (check for prompt return)
    sleep 5
done

echo -e "${GREEN}Polish session created: $SESSION${NC}"
echo -e "${YELLOW}Attach with: tmux attach -t $SESSION${NC}"
echo -e "${YELLOW}Or: flywheel attach polish${NC}"
