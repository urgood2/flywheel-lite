#!/usr/bin/env bash
# flywheel-polish: Interactive bead refinement ("Measure N Times, Implement Once")
# Based on Doodlestein methodology - manual review after each round
set -euo pipefail

export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

MAX_ROUNDS="${1:-9}"
PLAN_FILE="${2:-planning/PLAN.md}"
PROJECT_DIR="$(pwd)"
PROJECT_NAME="$(basename "$PROJECT_DIR")"
[[ -f "$HOME/.config/flywheel/config.env" ]] && source "$HOME/.config/flywheel/config.env"
[[ -f "$PROJECT_DIR/.flywheel/config.env" ]] && source "$PROJECT_DIR/.flywheel/config.env"
: "${FW_BROWNFIELD_PREFLIGHT_FILE:=planning/BROWNFIELD_PREFLIGHT.md}"
PREFLIGHT_FILE="$PROJECT_DIR/$FW_BROWNFIELD_PREFLIGHT_FILE"
if command -v flywheel-brownfield-preflight >/dev/null 2>&1; then
    flywheel-brownfield-preflight --quiet || true
fi


# Colors
RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
CYAN="\033[0;36m"
BOLD="\033[1m"
NC="\033[0m"

clear 2>/dev/null || true
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  ${BOLD}FLYWHEEL POLISH${NC}${BLUE} - Interactive Bead Refinement                    â•‘${NC}"
echo -e "${BLUE}â•‘  \"Measure N times, implement once\"                                â•‘${NC}"
echo -e "${BLUE}â•‘  Project: $PROJECT_NAME${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

# Check prerequisites
if [[ ! -f "$PLAN_FILE" ]]; then
    echo -e "${RED}Error: Plan file not found: $PLAN_FILE${NC}"
    echo "Usage: flywheel polish [plan-file]"
    echo "Default: planning/PLAN.md"
    exit 1
fi

# Check for beads tools
BEADS_CMD=""
if command -v br &> /dev/null; then
    BEADS_CMD="br"
elif command -v bd &> /dev/null; then
    BEADS_CMD="bd"
else
    echo -e "${RED}Error: br/bd (beads) not found${NC}"
    exit 1
fi

# Check for claude
if ! command -v claude &> /dev/null; then
    echo -e "${RED}Error: claude CLI not found${NC}"
    exit 1
fi

echo -e "${BOLD}ðŸ“„ Plan file:${NC} $PLAN_FILE"
echo -e "${BOLD}ðŸ”§ Beads tool:${NC} $BEADS_CMD"
echo

# Count beads
BEAD_COUNT=$($BEADS_CMD list 2>/dev/null | wc -l || echo "0")
echo -e "${YELLOW}Current bead count: $BEAD_COUNT${NC}"

if [[ "$BEAD_COUNT" -lt 1 ]]; then
    echo -e "${RED}No beads found. Run 'flywheel beads' first.${NC}"
    exit 1
fi

echo
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  HOW THIS WORKS (Doodlestein Method)${NC}"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo
echo "  1. Run polish prompt in Claude Code"
echo "  2. Review output - are improvements still happening?"
echo "  3. Choose: [C]ontinue / [F]resh session / [X]Codex final / [D]one"
echo "  4. Repeat 6-9 times until steady state"
echo "  5. Final pass with Codex (different model = fresh perspective)"
echo
read -p "Press Enter to start first iteration..."

# The main polish prompt
POLISH_PROMPT="Reread AGENTS.md so it is still fresh in your mind. Then read ALL of $PLAN_FILE and $PREFLIGHT_FILE (if present). Use ultrathink. Check over each bead super carefully-- are you sure it makes sense? Is it optimal? Could we change anything to make the system work better for users? If so, revise the beads. It is a lot easier and faster to operate in plan space before we start implementing these things!

DO NOT OVERSIMPLIFY THINGS! DO NOT LOSE ANY FEATURES OR FUNCTIONALITY!

Also make sure that as part of the beads we include comprehensive unit tests and e2e test scripts with great, detailed logging so we can be sure that everything is working perfectly after implementation. It is critical that EVERYTHING from the markdown plan be embedded into the beads so that we never need to refer back to the markdown plan and we do not lose any important context or ideas or insights into the new features planned and why we are making them.

Remember to ONLY use the $BEADS_CMD tool to create and modify the beads and add the dependencies."

# Fresh context prompt (for new session after flatline)
FRESH_CONTEXT_PROMPT="First read ALL of the AGENTS.md file and README.md file super carefully and understand ALL of both! Then use your code investigation agent mode to fully understand the code, and technical architecture and purpose of the project. Use ultrathink."

FRESH_FOLLOWUP_PROMPT="We recently transformed a markdown plan file into a bunch of new beads. I want you to very carefully review and analyze these using $BEADS_CMD and bv.

$POLISH_PROMPT"

round=0
session_num=1

while true; do
    ((++round))
    
    echo
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}  ITERATION $round (Session $session_num)${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo
    
    # Show bead count before
    BEFORE_COUNT=$($BEADS_CMD list 2>/dev/null | wc -l || echo "0")
    echo -e "${YELLOW}Beads before: $BEFORE_COUNT${NC}"
    echo
    
    echo -e "${BOLD}Running Claude Code...${NC}"
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    # Run claude with the polish prompt
    echo "$POLISH_PROMPT" | claude -p --dangerously-skip-permissions 2>&1 | tee "/tmp/polish_round_${round}.log"
    
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo
    
    # Show bead count after
    AFTER_COUNT=$($BEADS_CMD list 2>/dev/null | wc -l || echo "0")
    echo -e "${YELLOW}Beads after: $AFTER_COUNT${NC}"
    
    if [[ "$AFTER_COUNT" -ne "$BEFORE_COUNT" ]]; then
        echo -e "${GREEN}Change: $((AFTER_COUNT - BEFORE_COUNT)) beads${NC}"
    else
        echo -e "${YELLOW}No change in bead count (may have modified existing beads)${NC}"
    fi
    echo
    
    # Decision point
    echo -e "${BOLD}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "Completed iteration $round."
    echo
    echo "  [C] Continue - improvements still happening (same session)"
    echo "  [F] Fresh session - flatlined, need fresh context"
    echo "  [X] Codex final - ready for final pass with different model"
    echo "  [D] Done - beads are polished enough"
    echo
    read -p "Choice [C/F/X/D]: " -n 1 -r
    echo
    
    case "${REPLY^^}" in
        C)
            echo -e "${GREEN}Continuing in same session...${NC}"
            ;;
        F)
            echo
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${CYAN}  FRESH CONTEXT RESET${NC}"
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo
            echo -e "${BOLD}Step 1: Loading fresh context...${NC}"
            echo
            
            # Run fresh context prompt
            echo "$FRESH_CONTEXT_PROMPT" | claude -p --dangerously-skip-permissions 2>&1 | tee "/tmp/polish_fresh_${session_num}.log"
            
            echo
            echo -e "${BOLD}Step 2: Re-analyzing beads with fresh eyes...${NC}"
            echo
            
            # Run followup prompt
            echo "$FRESH_FOLLOWUP_PROMPT" | claude -p --dangerously-skip-permissions 2>&1 | tee -a "/tmp/polish_fresh_${session_num}.log"
            
            ((++session_num))
            echo -e "${GREEN}Fresh session complete. Now on session $session_num.${NC}"
            ;;
        X)
            echo
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${CYAN}  FINAL PASS WITH CODEX${NC}"
            echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo
            
            if command -v codex &> /dev/null; then
                echo -e "${BOLD}Running Codex with high reasoning effort...${NC}"
                echo
                # Note: codex CLI syntax may vary
                echo "$POLISH_PROMPT" | codex exec --model gpt-5.2 --config model_reasoning_effort="high" - 2>&1 | tee "/tmp/polish_codex_final.log" || {
                    echo -e "${YELLOW}Codex command failed. Try manually:${NC}"
                    echo "  codex exec --model gpt-5.2 --config model_reasoning_effort="high" -"
                    echo "  Then paste the polish prompt"
                }
            else
                echo -e "${YELLOW}Codex CLI not found. Run manually:${NC}"
                echo
                echo "  1. Open Codex or use OpenAI API"
                echo "  2. Set reasoning effort to HIGH"
                echo "  3. Run this prompt:"
                echo
                echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
                echo "$POLISH_PROMPT"
                echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
                echo
                read -p "Press Enter when Codex pass is complete..."
            fi
            
            echo
            echo -e "${GREEN}Codex final pass complete!${NC}"
            break
            ;;
        D|*)
            echo -e "${GREEN}Polish complete after $round iterations.${NC}"
            break
            ;;
    esac
done

# Final summary
echo
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘  ${BOLD}POLISH COMPLETE${NC}${GREEN}                                                   â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo
echo -e "${BOLD}Summary:${NC}"
echo "  Iterations: $round"
echo "  Sessions: $session_num"
echo "  Final bead count: $($BEADS_CMD list 2>/dev/null | wc -l || echo "?")"
echo
echo -e "${BOLD}Logs saved to:${NC}"
ls -la /tmp/polish_*.log 2>/dev/null | tail -5
echo
echo -e "${BOLD}Next step:${NC}"
echo "  flywheel startwork --cc 2    # Start agent swarm to implement"
echo
