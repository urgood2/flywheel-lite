#!/usr/bin/env bash
# flywheel-polish: Iterative bead refinement ("Measure N Times")
set -euo pipefail

# Add common tool paths
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

MAX_ITERS=${1:-9}
PLAN_FILE="${2:-planning/PLAN.md}"
PROJECT_DIR="$(pwd)"
PROJECT_NAME="$(basename "$PROJECT_DIR")"

# Colors
RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
NC="\033[0m"

echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}  FLYWHEEL POLISH - Iterative Bead Refinement${NC}"
echo -e "${BLUE}  Max iterations: $MAX_ITERS | Plan: $PLAN_FILE${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

# Check prerequisites
if [[ ! -f "$PLAN_FILE" ]]; then
    echo -e "${RED}Error: Plan file not found: $PLAN_FILE${NC}"
    echo -e "Create the plan first with: flywheel plan-pro or flywheel plan"
    exit 1
fi

if ! command -v br &> /dev/null && ! command -v bd &> /dev/null; then
    echo -e "${RED}Error: br/bd (beads) not found in PATH${NC}"
    echo -e "Install beads or add ~/.local/bin to PATH"
    exit 1
fi

# Prefer br over bd
BEADS_CMD="br"
command -v br &> /dev/null || BEADS_CMD="bd"

# Count initial beads
INITIAL_COUNT=0
BEAD_OUTPUT="$($BEADS_CMD list 2>&1)" || true
if echo "$BEAD_OUTPUT" | grep -q "id"; then
    INITIAL_COUNT=$(echo "$BEAD_OUTPUT" | grep -c "id") || INITIAL_COUNT=0
fi
echo -e "${YELLOW}Initial bead count: $INITIAL_COUNT${NC}"
echo

if [[ "$INITIAL_COUNT" -lt 1 ]]; then
    echo -e "${YELLOW}No beads found. Run 'flywheel beads' first to create beads from plan.${NC}"
    echo -e "Or continue anyway to create beads during polish iterations."
    read -p "Continue anyway? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Create tmux session for polish
SESSION="polish-$PROJECT_NAME"

if tmux has-session -t "$SESSION" 2>/dev/null; then
    echo -e "${YELLOW}Existing polish session found.${NC}"
    echo "  Attach: tmux attach -t $SESSION"
    echo "  Kill:   tmux kill-session -t $SESSION"
    read -p "Attach to existing session? [Y/n] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Nn]$ ]]; then
        tmux attach -t "$SESSION"
        exit 0
    fi
    tmux kill-session -t "$SESSION"
fi

echo -e "${GREEN}Creating polish session: $SESSION${NC}"
echo -e "Iterations: $MAX_ITERS"
echo

# Save prompt to temp file for tmux
PROMPT_FILE="/tmp/polish_prompt_$$.txt"
cat > "$PROMPT_FILE" << PROMPTEOF
Reread AGENTS.md so it is still fresh in your mind. Then read ALL of $PLAN_FILE.

Use ultrathink. Check over each bead super carefully-- are you sure it makes sense? Is it optimal? Could we change anything to make the system work better for users? If so, revise the beads. It is a lot easier and faster to operate in plan space before we start implementing these things!

DO NOT OVERSIMPLIFY THINGS! DO NOT LOSE ANY FEATURES OR FUNCTIONALITY!

Also make sure that as part of the beads we include comprehensive unit tests and e2e test scripts with great, detailed logging so we can be sure that everything is working perfectly after implementation. It is critical that EVERYTHING from the markdown plan be embedded into the beads so that we never need to refer back to the markdown plan and we do not lose any important context or ideas or insights into the new features planned and why we are making them.

Remember to ONLY use the bd/br tool to create and modify the beads and add the dependencies.
PROMPTEOF

# Create session
tmux new-session -d -s "$SESSION" -c "$PROJECT_DIR"

# Send initial message
tmux send-keys -t "$SESSION" "echo '=== FLYWHEEL POLISH - $MAX_ITERS iterations ===' && echo 'Plan: $PLAN_FILE' && sleep 2" Enter

# For each iteration, send the claude command
for i in $(seq 1 $MAX_ITERS); do
    tmux send-keys -t "$SESSION" "echo '' && echo '════════════════════════════════════════════════════════════' && echo '  POLISH ITERATION $i/$MAX_ITERS' && echo '════════════════════════════════════════════════════════════'" Enter
    
    # Send claude command
    tmux send-keys -t "$SESSION" "claude --dangerously-skip-permissions -p \"$(cat $PROMPT_FILE)\"" Enter
    
    # Wait between iterations
    tmux send-keys -t "$SESSION" "echo '>>> Iteration $i complete. Waiting 5s...' && sleep 5" Enter
done

# Final summary
tmux send-keys -t "$SESSION" "echo '' && echo '=== ALL POLISH ITERATIONS COMPLETE ===' && $BEADS_CMD list 2>/dev/null | head -30" Enter

# Cleanup
rm -f "$PROMPT_FILE"

echo -e "${GREEN}Polish session created: $SESSION${NC}"
echo
echo -e "Commands:"
echo -e "  Attach:  tmux attach -t $SESSION"
echo -e "  Detach:  Ctrl+B D (inside tmux)"
echo -e "  Kill:    tmux kill-session -t $SESSION"
echo
read -p "Attach now? [Y/n] " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    tmux attach -t "$SESSION"
fi
